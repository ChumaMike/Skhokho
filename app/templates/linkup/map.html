{% extends 'base.html' %}
{% block title %}LinkUp Maps{% endblock %}
{% block content %}
<div class="bg-zinc-900 rounded-xl border border-zinc-800 overflow-hidden shadow-2xl">
    <!-- Header with controls -->
    <div class="bg-zinc-950 border-b border-zinc-800 px-6 py-4 flex flex-wrap justify-between items-center gap-4">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-red-600 rounded-lg flex items-center justify-center">
                <i class="fas fa-map-marked-alt text-white"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-white">LinkUp Maps</h1>
                <p class="text-xs text-zinc-400">Services & Civic Issues Visualization</p>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <button id="toggleServices" class="px-4 py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-xs font-bold text-white hover:bg-zinc-700 transition flex items-center gap-2">
                <i class="fas fa-briefcase text-blue-500"></i> Show Services
            </button>
            <button id="toggleIssues" class="px-4 py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-xs font-bold text-white hover:bg-zinc-700 transition flex items-center gap-2">
                <i class="fas fa-exclamation-circle text-red-500"></i> Show Issues
            </button>
            <a href="{{ url_for('linkup.economy_view') }}" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-xs font-bold transition flex items-center gap-2">
                <i class="fas fa-chart-line"></i> Economy View
            </a>
        </div>
    </div>

    <!-- Map container -->
    <div id="map" class="w-full h-[70vh]"></div>

    <!-- Legend -->
    <div class="bg-zinc-950 border-t border-zinc-800 px-6 py-3">
        <div class="flex flex-wrap gap-6 text-xs text-zinc-400">
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-blue-600 rounded-full"></div>
                <span>Services ({{ services_count }})</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-red-600 rounded-full"></div>
                <span>Issues ({{ issues_count }})</span>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map centered on Soweto
    const map = L.map('map').setView([-26.23, 27.85], 13);

    // Add OpenStreetMap tile layer with dark theme
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
        maxZoom: 19
    }).addTo(map);

    // Create custom icons
    const serviceIcon = L.divIcon({
        className: 'custom-marker',
        html: '<div style="background-color: #2563eb; color: white; padding: 8px 12px; border-radius: 50%; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);"><i class="fas fa-briefcase"></i></div>',
        iconSize: [40, 40],
        iconAnchor: [20, 20]
    });

    const issueIcon = L.divIcon({
        className: 'custom-marker',
        html: '<div style="background-color: #dc2626; color: white; padding: 8px 12px; border-radius: 50%; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);"><i class="fas fa-exclamation-circle"></i></div>',
        iconSize: [40, 40],
        iconAnchor: [20, 20]
    });

    // Layer groups for markers
    const servicesLayer = L.layerGroup().addTo(map);
    const issuesLayer = L.layerGroup().addTo(map);

    // Fetch map data from API
    fetch('{{ url_for("main.map_data") }}')
        .then(response => response.json())
        .then(data => {
            // Add service markers
            data.services.forEach(service => {
                const marker = L.marker([service.lat, service.lng], {
                    icon: serviceIcon
                }).addTo(servicesLayer);
                
                marker.bindPopup(`
                    <div style="padding: 12px; min-width: 200px;">
                        <h3 style="margin: 0 0 8px 0; color: #2563eb; font-size: 14px; font-weight: bold;">${service.title}</h3>
                        <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">Category: ${service.category}</p>
                        <p style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold; color: #1f2937;">R${service.price}</p>
                        <button onclick="hireService(${service.id})" style="background-color: #2563eb; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">
                            <i class="fas fa-handshake"></i> Hire
                        </button>
                    </div>
                `);
            });

            // Add issue markers
            data.issues.forEach(issue => {
                const marker = L.marker([issue.lat, issue.lng], {
                    icon: issueIcon
                }).addTo(issuesLayer);
                
                marker.bindPopup(`
                    <div style="padding: 12px; min-width: 200px;">
                        <h3 style="margin: 0 0 8px 0; color: #dc2626; font-size: 14px; font-weight: bold;">${issue.title}</h3>
                        <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">Severity: ${issue.severity}/10</p>
                        <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">Status: ${issue.status}</p>
                    </div>
                `);
            });

            // Update legend counts
            document.querySelector('#toggleServices span:last-child').textContent = `Show Services (${data.services.length})`;
            document.querySelector('#toggleIssues span:last-child').textContent = `Show Issues (${data.issues.length})`;
        })
        .catch(error => {
            console.error('Error fetching map data:', error);
        });

    // Toggle services layer
    document.getElementById('toggleServices').addEventListener('click', function() {
        if (map.hasLayer(servicesLayer)) {
            map.removeLayer(servicesLayer);
            this.classList.add('bg-zinc-700');
            this.classList.remove('bg-zinc-800');
            this.querySelector('i').classList.add('opacity-50');
        } else {
            map.addLayer(servicesLayer);
            this.classList.remove('bg-zinc-700');
            this.classList.add('bg-zinc-800');
            this.querySelector('i').classList.remove('opacity-50');
        }
    });

    // Toggle issues layer
    document.getElementById('toggleIssues').addEventListener('click', function() {
        if (map.hasLayer(issuesLayer)) {
            map.removeLayer(issuesLayer);
            this.classList.add('bg-zinc-700');
            this.classList.remove('bg-zinc-800');
            this.querySelector('i').classList.add('opacity-50');
        } else {
            map.addLayer(issuesLayer);
            this.classList.remove('bg-zinc-700');
            this.classList.add('bg-zinc-800');
            this.querySelector('i').classList.remove('opacity-50');
        }
    });
});

// Hire service function
window.hireService = function(serviceId) {
    // Create form and submit it to hire route
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/linkup/hire/${serviceId}`;
    document.body.appendChild(form);
    form.submit();
};
</script>
{% endblock %}
