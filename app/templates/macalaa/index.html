{% extends "base.html" %}

{% block title %}Macalaa Vision{% endblock %}

{% block content %}
<div class="h-[80vh] flex flex-col items-center justify-center relative overflow-hidden bg-black rounded-xl border border-gray-800">
    
    <video id="video" autoplay playsinline class="absolute inset-0 w-full h-full object-cover opacity-60"></video>
    
    <div class="absolute inset-0 border-2 border-red-500/30 rounded-xl pointer-events-none z-10 flex flex-col justify-between p-6">
        <div class="flex justify-between">
            <span class="text-red-500 font-mono text-xs animate-pulse">REC ‚óè</span>
            <span class="text-red-500 font-mono text-xs">MACALAA.AI</span>
        </div>
        <div class="text-center">
            <div id="scan-line" class="w-full h-0.5 bg-red-500 shadow-[0_0_15px_rgba(239,68,68,1)] animate-scan"></div>
        </div>
        <div class="text-right">
            <span class="text-red-500 font-mono text-xs">SYS: ONLINE</span>
        </div>
    </div>

    <div class="absolute bottom-10 z-50 flex flex-col items-center gap-4 w-full px-6">
        
        <div id="result-box" class="hidden bg-black/90 backdrop-blur-xl border border-gray-700 p-4 rounded-xl w-full max-w-sm text-center shadow-2xl">
            <h3 id="result-title" class="text-lg font-bold text-white mb-1">Analyzing...</h3>
            <p id="result-desc" class="text-gray-400 text-sm mb-3">Please wait.</p>
            <div id="result-alert" class="text-xs font-bold text-red-400 uppercase tracking-widest animate-pulse"></div>
        </div>

        <button id="snap-btn" class="w-20 h-20 bg-white rounded-full border-4 border-gray-300 shadow-xl flex items-center justify-center hover:scale-105 transition active:scale-95 group">
            <div class="w-16 h-16 bg-red-600 rounded-full group-hover:bg-red-500 transition"></div>
        </button>
    </div>

    <canvas id="canvas" class="hidden"></canvas>
</div>

<style>
@keyframes scan {
    0% { transform: translateY(-30vh); opacity: 0; }
    50% { opacity: 1; }
    100% { transform: translateY(30vh); opacity: 0; }
}
.animate-scan { animation: scan 3s infinite linear; }
</style>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const snapBtn = document.getElementById('snap-btn');
    const resultBox = document.getElementById('result-box');
    const resultTitle = document.getElementById('result-title');
    const resultDesc = document.getElementById('result-desc');
    const resultAlert = document.getElementById('result-alert');

    // 1. Start Camera
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
        } catch (err) {
            alert("Camera Access Denied. Please enable camera permissions.");
        }
    }
    startCamera();

    // 2. Capture & Analyze
    snapBtn.addEventListener('click', () => {
        // Visual Feedback
        snapBtn.classList.add('animate-ping');
        setTimeout(() => snapBtn.classList.remove('animate-ping'), 500);

        // Capture Frame
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        // Convert to Blob
        canvas.toBlob((blob) => {
            sendToMacalaa(blob);
        }, 'image/jpeg', 0.8);
    });

    async function sendToMacalaa(imageBlob) {
        // Show Loading State
        resultBox.classList.remove('hidden');
        resultTitle.innerText = "Processing...";
        resultDesc.innerText = "Macalaa is analyzing the scene...";
        resultAlert.innerText = "";

        const formData = new FormData();
        formData.append('image', imageBlob, 'capture.jpg');

        try {
            const response = await fetch("{{ url_for('macalaa.scan') }}", {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.result) {
                // UPDATE UI
                resultTitle.innerText = data.result.category.toUpperCase();
                resultDesc.innerText = data.result.description;
                
                // Color Code Danger
                if (data.result.danger_level === 'CRITICAL') {
                    resultTitle.className = "text-lg font-bold text-red-500";
                    // Speak it out for accessibility
                    speak(data.result.description + ". Warning: Critical Danger Detected.");
                } else {
                    resultTitle.className = "text-lg font-bold text-green-400";
                    speak(data.result.description);
                }

                if (data.alert) {
                    resultAlert.innerText = data.alert;
                }
            }

        } catch (err) {
            resultTitle.innerText = "Error";
            resultDesc.innerText = "Could not connect to Skhokho Brain.";
        }
    }

    // Text-to-Speech Helper
    function speak(text) {
        const utterance = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.speak(utterance);
    }
</script>
{% endblock %}